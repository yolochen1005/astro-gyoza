---
interface Props {
  class?: string
}

const { class: className } = Astro.props
---

<article id="markdown-wrapper" class="markdown" class:list={[className]}>
  <slot />
</article>

<script is:inline>
  /* ================= ä»£ç å—å¤åˆ¶æŒ‰é’® ================= */

  function addCopyButtons() {
    document.querySelectorAll('#markdown-wrapper .code-block > pre').forEach((pre) => {
      // å¦‚æžœå·²ç»è¢«åŒ…è¿‡ï¼Œç›´æŽ¥è·³è¿‡
      if (pre.parentElement?.classList.contains('code-block-wrapper')) return

      const code = pre.querySelector('code')
      if (!code) return

      /* å¤–å±‚å®¹å™¨ï¼šè´Ÿè´£å®šä½ï¼Œä¸æ»šåŠ¨ */
      const wrapper = document.createElement('div')
      wrapper.className = 'code-block-wrapper'
      Object.assign(wrapper.style, {
        position: 'relative',
      })

      // ç”¨ wrapper åŒ…ä½ pre
      pre.parentNode.insertBefore(wrapper, pre)
      wrapper.appendChild(pre)

      /* å¤åˆ¶æŒ‰é’® */
      const btn = document.createElement('button')
      btn.textContent = 'ðŸ“‹'
      Object.assign(btn.style, {
        position: 'absolute',
        top: '8px',
        right: '8px',
        padding: '4px 6px',
        borderRadius: '6px',
        border: 'none',
        cursor: 'pointer',
        background: 'rgba(255,255,255,0.85)',
        backdropFilter: 'blur(6px)',
        color: '#111',
        transition: 'all 0.2s ease-in-out',
        zIndex: '20',
        fontSize: '14px',
      })

      /* æˆåŠŸæç¤º */
      const check = document.createElement('span')
      check.textContent = 'âœ”ï¸'
      Object.assign(check.style, {
        position: 'absolute',
        top: '8px',
        right: '8px',
        color: '#34d399',
        transition: 'opacity 0.2s ease-in-out',
        opacity: '0',
        zIndex: '10',
        fontSize: '14px',
      })

      btn.addEventListener('click', () => {
        navigator.clipboard.writeText(code.innerText)
        btn.style.opacity = '0'
        check.style.opacity = '1'

        setTimeout(() => {
          btn.style.opacity = '1'
          check.style.opacity = '0'
        }, 2000)
      })

      wrapper.appendChild(btn)
      wrapper.appendChild(check)
    })
  }

  /* ================= å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ ================= */

  function enableImageZoom() {
    document.querySelectorAll('#markdown-wrapper figure img').forEach((img) => {
      if (img.dataset.zoomBound) return
      img.dataset.zoomBound = 'true'

      img.style.cursor = 'zoom-in'

      img.addEventListener('click', () => {
        const overlay = document.createElement('div')
        overlay.className = 'image-zoom-overlay'
        Object.assign(overlay.style, {
          position: 'fixed',
          inset: '0',
          background: 'rgba(0,0,0,0.7)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: '9999',
        })

        const zoomedImg = img.cloneNode(true)
        Object.assign(zoomedImg.style, {
          maxWidth: '90vw',
          maxHeight: '90vh',
          cursor: 'zoom-out',
          boxShadow: '0 10px 40px rgba(0,0,0,0.4)',
        })

        overlay.appendChild(zoomedImg)
        document.body.appendChild(overlay)

        overlay.addEventListener('click', () => {
          overlay.remove()
        })
      })
    })
  }

  /* ================= ç»Ÿä¸€åˆå§‹åŒ– ================= */

  function initMarkdownEnhancements() {
    addCopyButtons()
    enableImageZoom()
  }

  window.addEventListener('load', () => {
    setTimeout(initMarkdownEnhancements, 0)
  })

  window.addEventListener('astro:after-swap', () => {
    setTimeout(initMarkdownEnhancements, 50)
  })

  setTimeout(initMarkdownEnhancements, 200)
</script>
