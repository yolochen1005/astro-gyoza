---
interface Props {
  class?: string
}

const { class: className } = Astro.props
---

<article id="markdown-wrapper" class="markdown" class:list={[className]}>
  <slot />
</article>

<script is:inline>
  function addCopyButtons() {
    document.querySelectorAll('#markdown-wrapper .code-block > pre').forEach((pre) => {
      if (pre.querySelector('.copy-btn-wrapper')) return

      const code = pre.querySelector('code')
      if (!code) return

      const wrapper = document.createElement('div')
      wrapper.className = 'copy-btn-wrapper'
      pre.style.position = 'relative'
      pre.appendChild(wrapper)

      const btn = document.createElement('button')
      btn.className = 'copy-btn'
      btn.textContent = 'ðŸ“‹'
      Object.assign(btn.style, {
        position: 'absolute',
        top: '8px',
        right: '8px',
        padding: '4px 6px',
        borderRadius: '6px',
        border: 'none',
        cursor: 'pointer',
        color: '#111',
        transition: 'all 0.2s ease-in-out',
        zIndex: '20',
        fontSize: '14px',
      })

      const check = document.createElement('span')
      check.textContent = 'âœ”ï¸'
      Object.assign(check.style, {
        position: 'absolute',
        top: '8px',
        right: '8px',
        color: '#34d399',
        transition: 'all 0.2s ease-in-out',
        opacity: '0',
        zIndex: '10',
        fontSize: '14px',
      })

      btn.addEventListener('click', () => {
        navigator.clipboard.writeText(code.innerText)
        btn.style.opacity = '0'
        check.style.opacity = '1'

        setTimeout(() => {
          btn.style.opacity = '1'
          check.style.opacity = '0'
        }, 2000)
      })

      wrapper.appendChild(btn)
      wrapper.appendChild(check)
    })
  }

  /* ================= å›¾ç‰‡ç‚¹å‡»æ”¾å¤§ ================= */

  function enableImageZoom() {
    document.querySelectorAll('#markdown-wrapper figure img').forEach((img) => {
      if (img.dataset.zoomBound) return
      img.dataset.zoomBound = 'true'

      img.style.cursor = 'zoom-in'

      img.addEventListener('click', () => {
        const overlay = document.createElement('div')
        overlay.className = 'image-zoom-overlay'

        const zoomedImg = img.cloneNode(true)
        zoomedImg.className = 'image-zoomed'
        zoomedImg.style.cursor = 'zoom-out'

        overlay.appendChild(zoomedImg)
        document.body.appendChild(overlay)

        overlay.addEventListener('click', () => {
          overlay.remove()
        })
      })
    })
  }

  /* ================= åˆå§‹åŒ–ç»Ÿä¸€å…¥å£ ================= */

  function initMarkdownEnhancements() {
    addCopyButtons()
    enableImageZoom()
  }

  window.addEventListener('load', () => {
    setTimeout(initMarkdownEnhancements, 0)
  })

  window.addEventListener('astro:after-swap', () => {
    setTimeout(initMarkdownEnhancements, 50)
  })

  setTimeout(initMarkdownEnhancements, 200)
</script>
